name: Send Commit Embed to Discord

on:
  push:
    branches:
      - '*'

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Send Discord Embed
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          AVATAR: ${{ github.event.sender.avatar_url }}
        run: |
          commits=$(jq -c '.commits[]' <<< '${{ toJson(github.event.commits) }}')

          DESCRIPTION=""
          while IFS= read -r commit; do
            msg=$(jq -r '.message' <<< "$commit")
            url=$(jq -r '.url' <<< "$commit")
            author=$(jq -r '.author.name' <<< "$commit")
            DESCRIPTION="$DESCRIPTION**[$author]**: [$msg]($url)\n"
          done <<< "$commits"

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"username\": \"GitHub Bot\",
                 \"avatar_url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\",
                 \"embeds\": [{
                     \"title\": \"ðŸš€ Push to $BRANCH\",
                     \"color\": 5814783,
                     \"author\": {
                        \"name\": \"$ACTOR\",
                        \"icon_url\": \"$AVATAR\",
                        \"url\": \"https://github.com/$ACTOR\"
                     },
                     \"description\": \"$DESCRIPTION\",
                     \"footer\": {
                       \"text\": \"$REPO\"
                     },
                     \"timestamp\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"
                 }]
               }" \
               "$DISCORD_WEBHOOK"
